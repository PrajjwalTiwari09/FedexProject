<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dynamic routing system with weather and emissions data.">
    <meta name="author" content="Your Name">
    <title>Dynamic Routing System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            width: 80%;
            margin: 0 auto;
            padding-top: 20px;
        }
        input, button, select {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
        }
        #map { 
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .summary-card {
            margin-top: 30px;
        }
        .loading-spinner {
            display: none;
            text-align: center;
        }
        .loading-spinner img {
            width: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dynamic Routing System</h1>
        <form id="routeForm">
            <label for="origin_place">Origin Place</label>
            <input type="text" id="origin_place" name="origin_place" required>
            <label for="dest_place">Destination Place</label>
            <input type="text" id="dest_place" name="dest_place" required>
            <label for="vehicle_type">Vehicle Type</label>
            <select id="vehicle_type" name="vehicle_type">
                <option value="Passenger Car">Passenger Car</option>
                <option value="Heavy-duty Truck">Heavy-duty Truck</option>
            </select>
            <label for="fuel_type">Fuel Type</label>
            <select id="fuel_type" name="fuel_type">
                <option value="Gasoline">Gasoline</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
            </select>
            <label for="model_year">Vehicle Model Year</label>
            <input type="number" id="model_year" name="model_year" required>
            <button type="submit">Calculate Route</button>
        </form>

        <div class="loading-spinner">
            <img src="https://i.gifer.com/4V0d.gif" alt="Loading...">
        </div>

        <div id="results"></div>
        <div id="map"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    $('#routeForm').on('submit', function(event) {
        event.preventDefault();
        $('.loading-spinner').show();
        
        $.ajax({
            type: 'POST',
            url: '/calculate',
            data: $(this).serialize(),
            success: function(response) {
                $('.loading-spinner').hide();
                displayResults(response);
            },
            error: function() {
                alert('An error occurred while processing your request.');
                $('.loading-spinner').hide();
            }
        });
    });

    function displayResults(data) {
        console.log(data); // Log the entire response to the console for inspection

        const resultsDiv = $('#results');
        resultsDiv.empty();

        if (data.error) {
            resultsDiv.append('<p>Error: ' + data.error + '</p>');
            return;
        }

        const emissions = data.emissions_kg;
        const distance = data.route_distance_km;
        const duration = data.route_duration_min;
        const weather = data.weather_data;

        resultsDiv.append(`
            <h3>Route Information</h3>
            <p>Distance: ${distance} km</p>
            <p>Duration: ${duration} minutes</p>
            <p>Emissions: ${emissions} kg CO₂</p>
            
            <h4>Weather Info at Origin</h4>
            <p>Temperature: ${weather.temperature}°C</p>
            <p>Condition: ${weather.condition}</p>
            <p>Humidity: ${weather.humidity}%</p>
            <p>AQI: ${weather.aqi}</p>
        `);

        // Extract the first and last points from the traffic data for origin and destination coordinates
        const firstPoint = data.traffic_data.routes[0].legs[0].points[0];
        const lastPoint = data.traffic_data.routes[0].legs[0].points[data.traffic_data.routes[0].legs[0].points.length - 1];
        
        const origin_coords = [firstPoint.latitude, firstPoint.longitude];
        const dest_coords = [lastPoint.latitude, lastPoint.longitude];

        // Add map visualization with Leaflet
        const map = L.map('map').setView(origin_coords, 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Mark origin and destination
        L.marker(origin_coords).addTo(map)
            .bindPopup('<b>Origin: ' + data.origin_place + '</b>')
            .openPopup();

        L.marker(dest_coords).addTo(map)
            .bindPopup('<b>Destination: ' + data.dest_place + '</b>');

        // Plot the route as a polyline from the points in the route
        const routeCoordinates = data.traffic_data.routes[0].legs[0].points.map(point => [point.latitude, point.longitude]);
        L.polyline(routeCoordinates, {color: 'blue'}).addTo(map);
    }
    </script>

</body>
</html>
